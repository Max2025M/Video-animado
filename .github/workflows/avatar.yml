name: Gerar Avatar

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: "URL direto da imagem do Google Drive"
        required: true
      audio_url:
        description: "URL direto do áudio do Google Drive"
        required: true

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      # ==========================================================
      # Configurar Python
      # ==========================================================
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Checkout repo
        uses: actions/checkout@v3

      # ==========================================================
      # Instalar dependências do sistema
      # ==========================================================
      - name: Instalar dependências do sistema
        run: |
          sudo apt-get update && sudo apt-get install -y \
            ffmpeg \
            libsm6 \
            libxext6 \
            libxrender1 \
            build-essential \
            && sudo rm -rf /var/lib/apt/lists/*

      # ==========================================================
      # Instalar dependências Python
      # ==========================================================
      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install numpy
          pip install opencv-python-headless
          pip install moviepy==1.0.3
          pip install pydub
          pip install librosa
          pip install soundfile
          pip install mediapipe
          pip install "imageio[ffmpeg]"

      # ==========================================================
      # Baixar arquivos (links diretos do Google Drive)
      # ==========================================================
      - name: Baixar arquivos
        run: |
          echo "Baixando imagem..."
          wget -O input_image "${{ github.event.inputs.image_url }}"
          echo "Baixando áudio..."
          wget -O input_audio "${{ github.event.inputs.audio_url }}"
          
          echo ""
          echo "=== Arquivos baixados ==="
          ls -lh input_image input_audio
          echo "========================="

      # ==========================================================
      # Mostrar informações da imagem
      # ==========================================================
      - name: Informações da imagem
        run: |
          python3 <<EOF
import cv2
img = cv2.imread("input_image")
h, w = img.shape[:2]
print(f"[LOG] Imagem input_image: {w}x{h} pixels")
EOF

      # ==========================================================
      # Gerar vídeo
      # ==========================================================
      - name: Gerar vídeo
        run: |
          python generate_avatar.py \
            --image input_image \
            --audio input_audio \
            --output output.mp4

      # ==========================================================
      # Salvar artefato
      # ==========================================================
      - name: Salvar artefato
        uses: actions/upload-artifact@v4
        with:
          name: avatar-video
          path: output.mp4

      # ==========================================================
      # Limpar arquivos temporários (executa sempre)
      # ==========================================================
      - name: Limpar arquivos temporários
        if: ${{ always() }}
        run: |
          rm -f input_image input_audio output.mp4
