name: Gerar Avatar

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: "URL da imagem"
        required: true
      audio_url:
        description: "URL do áudio"
        required: true
      start:
        description: "Início do áudio (s)"
        required: false
        default: "0"
      end:
        description: "Fim do áudio (s)"
        required: false
        default: "0"

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Baixar arquivos
        run: |
          wget -O input_image "${{ github.event.inputs.image_url }}"
          wget -O input_audio "${{ github.event.inputs.audio_url }}"

      - name: Gerar vídeo
        run: |
          python generate_avatar.py \
            --image input_image \
            --audio input_audio \
            --start ${{ github.event.inputs.start }} \
            --end ${{ github.event.inputs.end }} \
            --output output.mp4

      - name: Salvar artefato
        uses: actions/upload-artifact@v4
        with:
          name: avatar-video
          path: output.mp4

      - name: Limpar arquivos temporários locais
        run: |
          rm -f input_image input_audio output.mp4

      - name: Excluir arquivos do Release
        if: ${{ always() }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_URL: ${{ github.event.inputs.image_url }}
          AUDIO_URL: ${{ github.event.inputs.audio_url }}
        run: |
          # Extrair IDs dos assets a partir da URL
          IMAGE_ID=$(curl -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$IMAGE_URL" | jq -r '.id')
          AUDIO_ID=$(curl -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "$AUDIO_URL" | jq -r '.id')

          # Excluir assets se existirem
          [ "$IMAGE_ID" != "null" ] && curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/$IMAGE_ID"
          [ "$AUDIO_ID" != "null" ] && curl -X DELETE -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/assets/$AUDIO_ID"
